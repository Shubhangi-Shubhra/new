<munit:test name="onboarding-resourcesFlow-success-test" description="Happy path for onboarding-resourcesFlow">


<!-- Mock update-flow (DB insert/merge) -->
<munit:behavior>
<munit-tools:mock-when processor="flow-ref">
<munit-tools:with-attributes>
<munit-tools:with-attribute attributeName="name" whereValue="update-flow"/>
</munit-tools:with-attributes>
<munit-tools:then-return>
<munit-tools:payload value="#[{}]" mediaType="application/java"/>
</munit-tools:then-return>
</munit-tools:mock-when>


<!-- Mock select-flow to return API_ID sequentially -->
<munit-tools:mock-when processor="flow-ref">
<munit-tools:with-attributes>
<munit-tools:with-attribute attributeName="name" whereValue="select-flow"/>
</munit-tools:with-attributes>
<munit-tools:then-return>
<munit-tools:payload><![CDATA[
#[
{ API_ID: 'ORG_21' },
{ API_ID: 'ORG_25' },
{ API_ID: 'ORG_22' },
{ API_ID: 'ORG_24' },
{ API_ID: 'ORG_29' },
{ API_ID: 'ORG_30' },
{ API_ID: 'ORG_31' }
]
]]></munit-tools:payload>
</munit-tools:then-return>
</munit-tools:mock-when>
</munit:behavior>


<munit:execution>
<munit:set-event>
<munit:payload><![CDATA[
[
{ "method": "PATCH", "URL": "https://example.com/p12" },
{ "method": "PATCH", "URL": "https://example.com/p1562" },
{ "method": "DELETE", "URL": "https://example.com/p21" },
{ "method": "PATCH", "URL": "https://example.com/unique" },
{ "method": "PATCH", "URL": "https://example.com/uni124689" },
{ "method": "DELETE", "URL": "https://example.com/unique1" },
{ "method": "POST", "URL": "https://local.com/unique1" }
]
]]></munit:payload>
<munit:attributes><![CDATA[
{
headers: {
lob: 'ORG'
}
}
]]></munit:attributes>
</munit:set-event>


<flow-ref name="onboarding-resourcesFlow"/>
</munit:execution>


<munit:validation>
<munit-tools:assert-that expression="#[payload]" is="#[MunitTools::equalTo([
{ method: 'PATCH', URL: 'https://example.com/p12', Status: 'success', Message: 'Record successfully inserted', API_ID: 'ORG_21' },
{ method: 'PATCH', URL: 'https://example.com/p1562', Status: 'success', Message: 'Record successfully inserted', API_ID: 'ORG_25' },
{ method: 'DELETE', URL: 'https://example.com/p21', Status: 'success', Message: 'Record successfully inserted', API_ID: 'ORG_22' },
{ method: 'PATCH', URL: 'https://example.com/unique', Status: 'success', Message: 'Record successfully inserted', API_ID: 'ORG_24' },
{ method: 'PATCH', URL: 'https://example.com/uni124689', Status: 'success', Message: 'Record successfully inserted', API_ID: 'ORG_29' },
{ method: 'DELETE', URL: 'https://example.com/unique1', Status: 'success', Message: 'Record successfully inserted', API_ID: 'ORG_30' },
{ method: 'POST', URL: 'https://local.com/unique1', Status: 'success', Message: 'Record successfully inserted', API_ID: 'ORG_31' }
])]"/>
</munit:validation>


</munit:test>
